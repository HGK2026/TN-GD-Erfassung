<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GD-Erfassung</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
      import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBSduIxEC1XtD37ppTgSaQtHImkXG1ofi4",
        authDomain: "gd-erfassung.firebaseapp.com",
        projectId: "gd-erfassung",
        databaseURL: "https://gd-erfassung-default-rtdb.europe-west1.firebasedatabase.app",
        storageBucket: "gd-erfassung.firebasestorage.app",
        messagingSenderId: "451038031834",
        appId: "1:451038031834:web:a420355561350904a99ae3",
        measurementId: "G-CXB7W3WE7J"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const dbRef = ref(db, 'aktuellerGD');

      // Live-Synchronisierung
      onValue(dbRef, (snapshot) => {
        const data = snapshot.val() || {};
        const counters = ['saalGesamt', 'saalKinder', 'saalBesucher', 'saalGaeste', 'empGesamt', 'empKinder', 'empBesucher', 'empGaeste'];
        counters.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          // Falls kein Wert im DB vorhanden, 0 anzeigen
          const value = (data[id] !== undefined && data[id] !== null && data[id] !== "") ? data[id] : 0;
          el.innerText = value;
        });

        const fields = ['datum', 'typ', 'beginn', 'ende', 'textwort', 'lied1', 'lied2', 'lied3', 'leiter', 'mit1', 'mit2', 'notizen'];
        fields.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          if (data[id] !== undefined && data[id] !== null) {
            // always sync the value from DB (avoids innerText/value confusion)
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') el.value = data[id];
            else el.innerText = data[id];
          } else {
            // fallback auf leeren Wert
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') el.value = "";
            else el.innerText = "0";
          }
        });
      });

      // Klickvariante (+/-)
      window.updateCount = function(id, delta) {
        const card = document.getElementById('card-' + id);
        if (card && card.classList.contains('locked')) return;

        const el = document.getElementById(id);
        if (!el) return;
        const currentVal = parseInt(el.innerText.replace(/\s/g, ''), 10) || 0;
        const newVal = currentVal + delta;
        
        if (newVal >= 0) {
          // nur den Zahlenwert aktualisieren
          update(ref(db, 'aktuellerGD'), { [id]: newVal });
        }
      };

      // Ãœberschreibvariante (Tippen auf Zahl)
      window.editCount = function(id) {
        const card = document.getElementById('card-' + id);
        if (card && card.classList.contains('locked')) return;

        const el = document.getElementById(id);
        if (!el) return;
        const currentVal = el.innerText;
        const newVal = prompt("Zahl manuell eingeben:", currentVal);
        
        if (newVal !== null) {
          const trimmed = newVal.trim();
          if (trimmed === "") {
            // allow clearing to 0
            update(ref(db, 'aktuellerGD'), { [id]: 0 });
          } else if (!isNaN(trimmed)) {
            const num = parseInt(trimmed, 10);
            if (num >= 0) {
              update(ref(db, 'aktuellerGD'), { [id]: num });
            }
          } else {
            alert("UngÃ¼ltige Eingabe. Bitte eine Zahl eingeben.");
          }
        }
      };

      window.toggleLock = function(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const btn = el.parentElement.querySelector('.lock-btn');
        // for inputs/selects/textarea toggle disabled
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') {
          el.disabled = !el.disabled;
          const isDisabled = el.disabled;
          if (btn) { btn.innerText = isDisabled ? "ðŸ”’" : "ðŸ”“"; btn.classList.toggle('locked', isDisabled); }
          if (isDisabled) {
            const valueToStore = el.value !== undefined ? el.value : "";
            update(ref(db, 'aktuellerGD'), { [id]: valueToStore });
          }
        }
      };

      window.toggleCounterLock = function(id) {
        const card = document.getElementById('card-' + id);
        if (!card) return;
        const lockBtn = card.querySelector('.lock-btn');
        const isLocked = card.classList.toggle('locked');
        if (lockBtn) {
          lockBtn.innerText = isLocked ? "ðŸ”’" : "ðŸ”“";
          lockBtn.classList.toggle('locked', isLocked);
        }
      };

      window.resetAll = function() {
        if (confirm("Wirklich alles auf Null setzen?")) {
          const resetData = {
            saalGesamt: 0, saalKinder: 0, saalBesucher: 0, saalGaeste: 0,
            empGesamt: 0, empKinder: 0, empBesucher: 0, empGaeste: 0,
            datum: "", typ: "", beginn: "", ende: "",
            textwort: "", lied1: "", lied2: "", lied3: "", leiter: "", mit1: "", mit2: "", notizen: ""
          };
          update(ref(db, 'aktuellerGD'), resetData);
        }
      };
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 10px auto; padding: 15px; background-color: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #1a3a5a; text-transform: uppercase; border-bottom: 3px solid #1a3a5a; padding-bottom: 10px; }
        .section-title { font-weight: bold; font-size: 1.1em; margin: 20px 0 10px 0; color: #1a3a5a; display: block; background: #d1d8e0; padding: 8px 12px; border-radius: 6px; }
        .row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .field-container { flex: 1; min-width: 220px; display: flex; flex-direction: column; position: relative; }
        .lock-btn { position: absolute; right: 0; top: 0; background: none; border: none; cursor: pointer; font-size: 20px; color: #bdc3c7; z-index: 5; }
        .lock-btn.locked { color: #e74c3c; }
        label { font-weight: 600; font-size: 0.85em; margin-bottom: 8px; color: #555; }
        input, select, textarea { padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; }
        input:disabled, textarea:disabled { background: #f8f9fa; color: #7f8c8d; }
        
        .counter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; width: 100%; }
        .counter-card { background: #fff; border: 2px solid #eee; padding: 15px; border-radius: 15px; text-align: center; position: relative; }
        .counter-card.locked { background: #f8f9fa; opacity: 0.7; }
        .counter-controls { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-top: 10px; }
        .btn-count { flex: 1; height: 50px; font-size: 28px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; color: white; }
        .plus { background-color: #27ae60; }
        .minus { background-color: #c0392b; }
        .count-value { font-size: 32px; font-weight: 800; min-width: 60px; cursor: pointer; display: inline-block; padding: 5px; }
        .counter-label { display:block; font-weight:700; margin-bottom:6px; color:#34495e; }

        .btn-pdf { width: 100%; background: #1a3a5a; color: white; padding: 20px; border: none; border-radius: 12px; font-size: 1.2em; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-reset { width: 100%; background: #e74c3c; color: white; padding: 10px; border: none; border-radius: 8px; font-size: 0.8em; cursor: pointer; margin-top: 10px; opacity: 0.9; }

        .page-select { margin-top: 10px; display:flex; gap:10px; align-items:center; }
    </style>
</head>
<body>

    <h1>GD-Erfassung</h1>

    <div class="row">
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('datum')">ðŸ”“</button>
            <label>Datum</label>
            <input type="date" id="datum">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('typ')">ðŸ”“</button>
            <label>Gottesdienst-Typ</label>
            <select id="typ">
                <option value="Sonntagsgottesdienst">Sonntagsgottesdienst</option>
                <option value="Wochengottesdienst">Wochengottesdienst</option>
                <option value="Kindergottesdienst">Kindergottesdienst</option>
                <option value="Jugendgottesdienst">Jugendgottesdienst</option>
                <option value="Entschlafenengottesdienst">Entschlafenengottesdienst</option>
                <option value="Anderer">Anderer</option>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('beginn')">ðŸ”“</button>
            <label>Beginn</label>
            <input type="time" id="beginn">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('ende')">ðŸ”“</button>
            <label>Ende</label>
            <input type="time" id="ende">
        </div>
    </div>

    <div class="row">
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('textwort')">ðŸ”“</button>
            <label>Textwort</label>
            <input type="text" id="textwort">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('lied1')">ðŸ”“</button>
            <label>Eingangslied</label>
            <input type="text" id="lied1">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('lied2')">ðŸ”“</button>
            <label>BuÃŸlied</label>
            <input type="text" id="lied2">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('lied3')">ðŸ”“</button>
            <label>Abendmahlslied</label>
            <input type="text" id="lied3">
        </div>
    </div>

    <div class="row">
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('leiter')">ðŸ”“</button>
            <label>Dienstleiter</label>
            <input type="text" id="leiter">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('mit1')">ðŸ”“</button>
            <label>1. Mitdienender</label>
            <input type="text" id="mit1">
        </div>
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('mit2')">ðŸ”“</button>
            <label>2. Mitdienender</label>
            <input type="text" id="mit2">
        </div>
    </div>

    <span class="section-title">Kirchensaal (Tippe auf Zahl zum Ã„ndern)</span>
    <div class="row">
        <div class="counter-grid">
            <div class="counter-card" id="card-saalGesamt">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('saalGesamt')">ðŸ”“</button>
                <span class="counter-label">Gesamt</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('saalGesamt', -1)">-</button>
                    <span id="saalGesamt" class="count-value" onclick="editCount('saalGesamt')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('saalGesamt', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-saalKinder">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('saalKinder')">ðŸ”“</button>
                <span class="counter-label">Kinder</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('saalKinder', -1)">-</button>
                    <span id="saalKinder" class="count-value" onclick="editCount('saalKinder')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('saalKinder', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-saalBesucher">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('saalBesucher')">ðŸ”“</button>
                <span class="counter-label">Besucher</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('saalBesucher', -1)">-</button>
                    <span id="saalBesucher" class="count-value" onclick="editCount('saalBesucher')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('saalBesucher', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-saalGaeste">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('saalGaeste')">ðŸ”“</button>
                <span class="counter-label">GÃ¤ste</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('saalGaeste', -1)">-</button>
                    <span id="saalGaeste" class="count-value" onclick="editCount('saalGaeste')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('saalGaeste', 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <span class="section-title">Empore / NebenrÃ¤ume</span>
    <div class="row">
        <div class="counter-grid">
            <div class="counter-card" id="card-empGesamt">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('empGesamt')">ðŸ”“</button>
                <span class="counter-label">Gesamt</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('empGesamt', -1)">-</button>
                    <span id="empGesamt" class="count-value" onclick="editCount('empGesamt')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('empGesamt', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-empKinder">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('empKinder')">ðŸ”“</button>
                <span class="counter-label">Kinder</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('empKinder', -1)">-</button>
                    <span id="empKinder" class="count-value" onclick="editCount('empKinder')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('empKinder', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-empBesucher">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('empBesucher')">ðŸ”“</button>
                <span class="counter-label">Besucher</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('empBesucher', -1)">-</button>
                    <span id="empBesucher" class="count-value" onclick="editCount('empBesucher')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('empBesucher', 1)">+</button>
                </div>
            </div>

            <div class="counter-card" id="card-empGaeste">
                <button type="button" class="lock-btn" onclick="toggleCounterLock('empGaeste')">ðŸ”“</button>
                <span class="counter-label">GÃ¤ste</span>
                <div class="counter-controls">
                    <button type="button" class="btn-count minus" onclick="updateCount('empGaeste', -1)">-</button>
                    <span id="empGaeste" class="count-value" onclick="editCount('empGaeste')">0</span>
                    <button type="button" class="btn-count plus" onclick="updateCount('empGaeste', 1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <span class="section-title">Notizen</span>
    <div class="row">
        <div class="field-container">
            <button type="button" class="lock-btn" onclick="toggleLock('notizen')">ðŸ”“</button>
            <textarea id="notizen" rows="10"></textarea>
        </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label for="seitenwahl">PDF: Seitenanzahl</label>
        <div class="page-select">
          <select id="seitenwahl" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
            <option value="3">3 Seiten</option>
            <option value="4">4 Seiten</option>
          </select>
          <small>WÃ¤hle 3 oder 4 Seiten fÃ¼r das PDF</small>
        </div>
      </div>
    </div>

    <button type="button" class="btn-pdf" onclick="generatePDF()">PDF ERZEUGEN</button>
    <button type="button" class="btn-reset" onclick="resetAll()">Daten-Reset (Alles auf Null)</button>

    <script>
        // PDF-Generierung mit wÃ¤hlbarer Seitenanzahl (3 oder 4)
        function generatePDF() {
            try {
                const pages = parseInt(document.getElementById('seitenwahl').value, 10) || 3;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p','mm','a4');
                const left = 20;
                const pageWidth = 210;
                const contentWidth = pageWidth - left - 20;

                function writeRow(doc, label, value, yRef, extraSpacing = 7) {
                  doc.setFont(undefined, 'bold'); doc.text(label + ": ", left, yRef.y);
                  doc.setFont(undefined, 'normal');
                  const lines = doc.splitTextToSize(String(value || ""), contentWidth - 40);
                  doc.text(lines, left + 40, yRef.y);
                  yRef.y += extraSpacing * (Array.isArray(lines) ? lines.length : 1);
                  yRef.y += 2;
                }

                function getField(id) {
                  const el = document.getElementById(id);
                  if (!el) return "";
                  if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') return el.value;
                  return el.innerText;
                }

                function getCount(id) {
                  const el = document.getElementById(id);
                  if (!el) return "0";
                  return el.innerText || "0";
                }

                // helper: reset y for each page
                let yRef = { y: 20 };

                // Page 1: Basisdaten
                doc.setFontSize(18);
                doc.text("GD-Erfassung", 105, yRef.y, { align: "center" });
                yRef.y += 10;
                doc.setFontSize(11);

                writeRow(doc, "Datum", getField('datum'), yRef);
                writeRow(doc, "Typ", getField('typ'), yRef);

                const beg = getField('beginn') || "";
                const end = getField('ende') || "";
                let zeit = "";
                if (beg && end) zeit = beg + " - " + end;
                else if (beg) zeit = beg;
                else if (end) zeit = end;
                writeRow(doc, "Zeit", zeit, yRef);

                writeRow(doc, "Textwort", getField('textwort'), yRef);
                writeRow(doc, "Lied 1 (Eingang)", getField('lied1'), yRef);
                writeRow(doc, "Lied 2 (BuÃŸlied)", getField('lied2'), yRef);
                writeRow(doc, "Lied 3 (Abendmahlslied)", getField('lied3'), yRef);
                writeRow(doc, "Leiter", getField('leiter'), yRef);
                writeRow(doc, "Mitdienender 1", getField('mit1'), yRef);
                writeRow(doc, "Mitdienender 2", getField('mit2'), yRef);

                // Decide how to split based on selected pages (3 or 4)
                // For 3 pages: page2 = Kirchensaal + page3 = Empore + Notizen/Summary
                // For 4 pages: page2 = Kirchensaal, page3 = Empore, page4 = Notizen + Summary
                function addNewPage() {
                  doc.addPage();
                  yRef.y = 20;
                }

                // Page 2: Kirchensaal
                addNewPage();
                doc.setFont(undefined, 'bold');
                doc.text("Kirchensaal", left, yRef.y);
                yRef.y += 8;
                doc.setFont(undefined, 'normal');
                writeRow(doc, "Saal - Gesamt", getCount('saalGesamt'), yRef);
                writeRow(doc, "Saal - Kinder", getCount('saalKinder'), yRef);
                writeRow(doc, "Saal - Besucher", getCount('saalBesucher'), yRef);
                writeRow(doc, "Saal - GÃ¤ste", getCount('saalGaeste'), yRef);

                if (pages === 3) {
                  // Page 3: Empore + Notizen/Summary
                  addNewPage();
                  doc.setFont(undefined, 'bold');
                  doc.text("Empore / NebenrÃ¤ume", left, yRef.y);
                  yRef.y += 8;
                  doc.setFont(undefined, 'normal');
                  writeRow(doc, "Empore - Gesamt", getCount('empGesamt'), yRef);
                  writeRow(doc, "Empore - Kinder", getCount('empKinder'), yRef);
                  writeRow(doc, "Empore - Besucher", getCount('empBesucher'), yRef);
                  writeRow(doc, "Empore - GÃ¤ste", getCount('empGaeste'), yRef);

                  yRef.y += 6;
                  writeRow(doc, "Notizen", getField('notizen'), yRef, 7);

                  // summary (kurz)
                  yRef.y += 6;
                  doc.setFont(undefined, 'bold');
                  doc.text("Zusammenfassung", left, yRef.y);
                  yRef.y += 6;
                  doc.setFont(undefined, 'normal');
                  writeRow(doc, "Gesamt (Saal+Empore)", (
                    (parseInt(getCount('saalGesamt')) || 0) + (parseInt(getCount('empGesamt')) || 0)
                  ), yRef);
                } else {
                  // pages === 4
                  // Page 3: Empore
                  addNewPage();
                  doc.setFont(undefined, 'bold');
                  doc.text("Empore / NebenrÃ¤ume", left, yRef.y);
                  yRef.y += 8;
                  doc.setFont(undefined, 'normal');
                  writeRow(doc, "Empore - Gesamt", getCount('empGesamt'), yRef);
                  writeRow(doc, "Empore - Kinder", getCount('empKinder'), yRef);
                  writeRow(doc, "Empore - Besucher", getCount('empBesucher'), yRef);
                  writeRow(doc, "Empore - GÃ¤ste", getCount('empGaeste'), yRef);

                  // Page 4: Notizen + Summary
                  addNewPage();
                  writeRow(doc, "Notizen", getField('notizen'), yRef, 7);

                  yRef.y += 6;
                  doc.setFont(undefined, 'bold');
                  doc.text("Zusammenfassung", left, yRef.y);
                  yRef.y += 6;
                  doc.setFont(undefined, 'normal');
                  writeRow(doc, "Gesamt (Saal+Empore)", (
                    (parseInt(getCount('saalGesamt')) || 0) + (parseInt(getCount('empGesamt')) || 0)
                  ), yRef);
                }

                doc.save("GD_Erfassung.pdf");
            } catch (err) {
                console.error("Fehler beim Erzeugen des PDFs:", err);
                alert("Fehler beim Erzeugen des PDFs. Details siehe Konsole.");
            }
        }
    </script>
</body>
</html>