<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, set } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBNehMzdBdfXKj8l1i3NxQgtWIkaCVnpHA",
    authDomain: "gd-erfassungtool.firebaseapp.com",
    databaseURL: "https://gd-erfassungtool-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "gd-erfassungtool",
    storageBucket: "gd-erfassungtool.firebasestorage.app",
    messagingSenderId: "66241308714",
    appId: "1:66241308714:web:d3390dc5681de2d8c0fb53",
    measurementId: "G-4WMBES6Q24"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db, 'aktuellerGD');

  // Diese Funktion berechnet die Summen lokal
  function calculateTotals() {
    const ids = ['saalGesamt', 'saalKinder', 'saalBesucher', 'saalGaeste', 'empGesamt', 'empKinder', 'empBesucher', 'empGaeste'];
    const val = {};
    ids.forEach(id => {
      const el = document.getElementById(id);
      val[id] = el ? parseInt(el.innerText) || 0 : 0;
    });
    document.getElementById('totalGesamt').innerText = val.saalGesamt + val.empGesamt;
    document.getElementById('totalKinder').innerText = val.saalKinder + val.empKinder;
    document.getElementById('totalBesucher').innerText = val.saalBesucher + val.empBesucher;
    document.getElementById('totalGaeste').innerText = val.saalGaeste + val.empGaeste;
  }

  // ECHTZEIT-SYNC: Das ist das Herzstück
  onValue(dbRef, (snapshot) => {
    const data = snapshot.val() || {};
    
    // Zähler aktualisieren (für alle sichtbar)
    const counters = ['saalGesamt', 'saalKinder', 'saalBesucher', 'saalGaeste', 'empGesamt', 'empKinder', 'empBesucher', 'empGaeste'];
    counters.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerText = data[id] !== undefined ? data[id] : 0;
    });

    // Textfelder aktualisieren (nur wenn nicht gerade getippt wird)
    const fields = ['datum', 'typ', 'beginn', 'ende', 'textwort', 'lied1', 'lied2', 'lied3', 'leiter', 'mit1', 'mit2', 'notizen'];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el && data[id] !== undefined) {
        // Wenn das Feld gesperrt ist oder der Fokus nicht darauf liegt, Wert übernehmen
        if (el.disabled || document.activeElement !== el) {
          el.value = data[id];
        }
      }
    });
    calculateTotals();
  });

  // Zähler hoch/runter (sendet sofort an Firebase)
  window.updateCount = function(id, delta) {
    if (document.getElementById('card-' + id)?.classList.contains('locked')) return;
    const el = document.getElementById(id);
    const current = parseInt(el.innerText) || 0;
    const newVal = Math.max(0, current + delta);
    
    // Wir updaten nur den einen Wert in Firebase
    update(ref(db, 'aktuellerGD'), { [id]: newVal });
  };

  window.quickAdd = function(targetId) {
    const val = document.getElementById(targetId).value;
    window.updateCount(val, 1);
  };

  // Reset-Funktion: Löscht die Datenbank-Einträge
  window.resetData = function() {
    if (confirm("Wirklich alles auf Null setzen?")) {
      set(dbRef, {
        saalGesamt: 0, saalKinder: 0, saalBesucher: 0, saalGaeste: 0,
        empGesamt: 0, empKinder: 0, empBesucher: 0, empGaeste: 0,
        datum: "", typ: "", beginn: "", ende: "", textwort: "",
        lied1: "", lied2: "", lied3: "", leiter: "", mit1: "", mit2: "", notizen: ""
      });
    }
  };

  // Restliche Navigation
  window.showPage = function(n) {
    document.querySelectorAll('.page').forEach((p, i) => p.style.display = (i+1 === n) ? 'block' : 'none');
    document.querySelectorAll('.nav-tab').forEach((b, i) => b.classList.toggle('active', i+1 === n));
  };
  window.addEventListener('DOMContentLoaded', () => window.showPage(1));
</script>
